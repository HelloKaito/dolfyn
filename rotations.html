
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Rotations and Coordinate Systems &#8212; DOLfYN 0.11.1 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <script type="text/javascript" src="_static/js/versionwarning.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Motion Correction" href="motion-correction.html" />
    <link rel="prev" title="Data Structure" href="data-structure.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="rotations-and-coordinate-systems">
<span id="rotations"></span><h1>Rotations and Coordinate Systems<a class="headerlink" href="#rotations-and-coordinate-systems" title="Permalink to this headline">¶</a></h1>
<p>One of DOLfYN’s primary advantages is that it contains simple tools
for managing the coordinate system (a.k.a. the reference frame) of the
vector data of data objects. This has taken considerable effort
because the coordinate system definitions used by instrument
manufacturers are not consistent, and the math/concepts of coordinate
rotations can be described as somewhere between <em>non-trivial</em> and
<em>absolutely maddening</em>. We hope that this page, and DOLfYN’s tools
for managing coordinate system help to reduce the burden of tracking
this information so that you – the researcher – can focus on what’s
important.</p>
<p>Having said that, the coordinate-system/rotation tools provided in
DOLfYN have been tested to varying degrees on different types of
instruments and configurations. Instrument manufacturers use different
conventions, and can change conventions with firmware
updates. Therefore, we make no promises that these tools will work for
any instrument type, but we do have higher confidence in some
instruments and configurations than others. See <a class="reference internal" href="#rotate-testing-table"><span class="std std-ref">the table</span></a> at the bottom of this page for details on the
degree of testing of DOLfYN’s rotations and coordinate-system tools
that has occurred for several instrument types. With your help, we
hope to improve our confidence in these tools for the wide-array of
instruments and configurations that exist.</p>
<p>The values in the list <code class="docutils literal notranslate"><span class="pre">dat.props['rotate_vars']</span></code> specifies the
vectors that are rotated when changing between different coordinate
systems.  The first dimension of these vectors are their coordinate
directions, which are defined by the following coordinate systems:</p>
<ul>
<li><p class="first"><strong>BEAM</strong>: this is the coordinate system of the ‘along-beam’
velocities.  When the data object is in BEAM coordinates, the first
dimension of the velocity vectors are: [beam1, beam2,
… beamN]. This coordinate system is <em>not</em> ortho-normal, which
means that the inverse rotation (inst to beam) cannot be computed
using the transpose of the beam-to-inst rotation matrix. Instead,
the inverse of the matrix must be computed explicitly, which is done
internally in DOLfYN (in <code class="xref py py-func docutils literal notranslate"><span class="pre">beam2inst()</span></code>).</p>
<p>When a data object is in this coordinate system, only the velocity
data (i.e., the variables in <code class="docutils literal notranslate"><span class="pre">dat.props['rotate_vars']</span></code> starting
with <code class="docutils literal notranslate"><span class="pre">'vel'</span></code>) is in beam coordinates. Other vector variables
listed in <code class="docutils literal notranslate"><span class="pre">'rotate_vars'</span></code> are in the INST frame (e.g.,
<cite>dat.orient.AngRt</cite>). This is true for data read from binary files
that is in beam coordinates, and also when rotating from other
coordinate systems to beam coordinates.</p>
</li>
<li><p class="first"><strong>INST</strong>: this is the ‘instrument’ coordinate system defined by the
manufacturer. This coordinate system is orth-normal, but is not
necessarily fixed. That is, if the instrument is rotating, then this
coordinate system changes relative to the earth. When the data
object is in INST coordinates, the first dimension of the vectors
are: [X, Y, Z, …].</p>
<p>Note: instruments with more than three beams will have more than
three velocity components. <strong>|dlfn| does not yet handle these extra
dimensions consistently</strong>.</p>
</li>
<li><p class="first"><strong>EARTH</strong>: When the data object is in EARTH coordinates, the first
dimension of vectors are: [East, North, Up, …]. This coordinate
system is also sometimes denoted as “ENU”. If the declination is set
the earth coordinate system is “True-East, True-North, Up”
otherwise, East and North are magnetic. See the <a class="reference internal" href="#declination-handling">Declination
Handling</a> section for further details on setting declination.</p>
<p>Note that the ENU definition used here is different from the ‘north,
east, down’ coordinate system typically used by aircraft.
Also note that the earth coordinate system is a ‘rotationally-fixed’
coordinate system: it does not rotate, but it is not necessarily
<em>inertial</em> or <em>stationary</em> if the instrument slides around
translationally (see the <a class="reference internal" href="motion-correction.html#motion-correction"><span class="std std-ref">Motion Correction</span></a> section for
details on how to correct for translational motion).</p>
</li>
<li><p class="first"><strong>PRINCIPAL</strong>: the principal coordinate system is a fixed coordinate
system that has been rotated in the horizontal plane (around the Up
axis) to align with the flow. In this coordinate system the first
dimension of a vector is meant to be: [Stream-wise, Cross-stream,
Up]. This coordinate system is defined by the variable
<code class="docutils literal notranslate"><span class="pre">dat.props['principal_heading']</span></code>, which specifies the
principal coordinate system’s <span class="math notranslate nohighlight">\(+u\)</span> direction. The
<span class="math notranslate nohighlight">\(v\)</span> direction is then defined by the right-hand-rule (with
<span class="math notranslate nohighlight">\(w\)</span> up). See the <a class="reference internal" href="#principal-heading">Principal Heading</a> section for further
details.</p>
</li>
</ul>
<p>To rotate a data object into one of these coordinate systems, simply
use the <code class="docutils literal notranslate"><span class="pre">rotate2</span></code> method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dat_earth</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">rotate2</span><span class="p">(</span><span class="s1">&#39;earth&#39;</span><span class="p">)</span>  <span class="c1"># (&quot;rotate to earth&quot;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dat_earth</span>
<span class="go">&lt;ADV data object&gt;</span>
<span class="go">  . 1.05 hours (started: Jun 12, 2012 12:00)</span>
<span class="go">  . EARTH-frame</span>
<span class="go">  . (120530 pings @ 32Hz)</span>
<span class="go">  *------------</span>
<span class="go">  | mpltime                  : &lt;time_array; (120530,); float64&gt;</span>
<span class="go">  | vel                      : &lt;array; (3, 120530); float32&gt;</span>
<span class="go">  + config                   : + DATA GROUP</span>
<span class="go">  + env                      : + DATA GROUP</span>
<span class="go">  + orient                   : + DATA GROUP</span>
<span class="go">  + props                    : + DATA GROUP</span>
<span class="go">  + signal                   : + DATA GROUP</span>
<span class="go">  + sys                      : + DATA GROUP</span>
</pre></div>
</div>
<div class="section" id="orientation-data">
<h2>Orientation Data<a class="headerlink" href="#orientation-data" title="Permalink to this headline">¶</a></h2>
<p>The instrument orientation data in DOLfYN data objects is contained in
the <code class="docutils literal notranslate"><span class="pre">orient</span></code> data group. The <code class="docutils literal notranslate"><span class="pre">orientmat</span></code> data item in this group
is the orientation matrix, <span class="math notranslate nohighlight">\(R\)</span>, of the instrument in the earth
reference frame. It is a 3x3xNt array, where each 3x3 array is the <a class="reference external" href="http://en.wikipedia.org/wiki/Rotation_matrix">rotation matrix</a> that rotates vectors
in the earth frame, <span class="math notranslate nohighlight">\(v_e\)</span>, into the instrument coordinate system,
<span class="math notranslate nohighlight">\(v_i\)</span>, at each timestep:</p>
<div class="math notranslate nohighlight">
\[v_i = R \cdot v_e\]</div>
<p>The ENU definitions of coordinate systems means that the rows of
<span class="math notranslate nohighlight">\(R\)</span> are the unit-vectors of the XYZ coordinate system in the ENU
reference frame, and the columns are the unit vectors of the ENU
coordinate system in the XYZ reference frame. That is, for this kind
of simple rotation matrix between two orthogonal coordinate systems,
the inverse rotation matrix is simply the transpose:</p>
<div class="math notranslate nohighlight">
\[v_e = R^T \cdot v_i\]</div>
</div>
<div class="section" id="heading-pitch-roll">
<h2>Heading, Pitch, Roll<a class="headerlink" href="#heading-pitch-roll" title="Permalink to this headline">¶</a></h2>
<p>Some (most?) instruments do not calculate or output the orientation
matrix by default. Instead, these instruments typically provide
<em>heading</em>, <em>pitch</em>, and <em>roll</em> data (hereafter, <em>h,p,r</em>).  Instruments that provide an <code class="docutils literal notranslate"><span class="pre">orientmat</span></code> directly will have
<code class="docutils literal notranslate"><span class="pre">dat.props['has_imu']</span> <span class="pre">=</span> <span class="pre">True</span></code>. Otherwise, the <code class="docutils literal notranslate"><span class="pre">orientmat</span></code> was
calculated from <em>h,p,r</em>.</p>
<p>Note that an orientation matrix calculated
from <em>h,p,r</em> can have larger error associated with it, partly because
of the <a class="reference external" href="https://en.wikipedia.org/wiki/Gimbal_lock">gimbal lock</a>
problem, and also because the accuracy of some <em>h,p,r</em> sensors
decreases for large pitch or roll angles (e.g., &gt;40 degrees).</p>
<p>Because the definitions of <em>h,p,r</em> are not consistent between
instrument makes/models, and because DOLfYN-developers have chosen
to utilize consistent definitions of orientation data (<code class="docutils literal notranslate"><span class="pre">orientmat</span></code>,
and <em>h,p,r</em>), the following things are true:</p>
<blockquote>
<div><ul class="simple">
<li>DOLfYN uses instrument-specific functions to calculate a
consistent <code class="docutils literal notranslate"><span class="pre">dat['orient']['orientmat']</span></code> from the inconsistent
definitions of <em>h,p,r</em></li>
<li>DOLfYN’s consistent definitions <em>h,p,r</em> are generally different
from the definitions provided by an instrument manufacturer (i.e.,
there is no consensus on these definitions, so DOLfYN developers
have chosen one)</li>
</ul>
</div></blockquote>
<p>Varying degrees of validation have been performed to confirm that the
<code class="docutils literal notranslate"><span class="pre">orientmat</span></code> is being calculated correctly for each instrument’s
definitions of <em>h,p,r</em>. See the <a class="reference internal" href="#rotate-testing-table"><span class="std std-ref">the table</span></a> at the bottom of this page for details on
this. If your instrument has low confidence, or you suspect an error
in rotating data into the earth coordinate system, and you have
interest in doing the work to fix this, please reach out to us
by filing an issue.</p>
<div class="section" id="dlfn-defined-heading-pitch-roll">
<h3>DOLfYN-Defined Heading, Pitch, Roll<a class="headerlink" href="#dlfn-defined-heading-pitch-roll" title="Permalink to this headline">¶</a></h3>
<p>The DOLfYN-defined <em>h,p,r</em> variables can be calculated using the
<code class="xref py py-func docutils literal notranslate"><span class="pre">dolfyn.orient2euler()</span></code> function (<code class="xref py py-func docutils literal notranslate"><span class="pre">dolfyn.euler2orient()</span></code>
provides the reverse functionality). This function computes these
variables according to the following conventions:</p>
<blockquote>
<div><ul class="simple">
<li>a “ZYX” rotation order. That is, these variables are computed
assuming that rotation from the earth -&gt; instrument frame happens
by rotating around the z-axis first (heading), then rotating
around the y-axis (pitch), then rotating around the x-axis (roll).</li>
<li>heading is defined as the direction the x-axis points, positive
clockwise from North (this is <em>opposite</em> the right-hand-rule
around the Z-axis)</li>
<li>pitch is positive when the x-axis pitches up (this is <em>opposite</em> the
right-hand-rule around the Y-axis)</li>
<li>roll is positive according to the right-hand-rule around the
instrument’s x-axis</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="instrument-heading-pitch-roll">
<h3>Instrument heading, pitch, roll<a class="headerlink" href="#instrument-heading-pitch-roll" title="Permalink to this headline">¶</a></h3>
<p>The raw <em>h,p,r</em> data as defined by the instrument manufacturer is
available in <code class="docutils literal notranslate"><span class="pre">dat['orient']['raw']</span></code>. Note that this data does not
obey the above definitions, and instead obeys the instrument
manufacturer’s definitions of these variables (i.e., it is exactly the
data contained in the binary file). Also note that
<code class="docutils literal notranslate"><span class="pre">dat['orient']['raw']['heading']</span></code> is unaffected by setting
declination as described in the next section.</p>
</div>
</div>
<div class="section" id="declination-handling">
<h2>Declination Handling<a class="headerlink" href="#declination-handling" title="Permalink to this headline">¶</a></h2>
<p>DOLfYN includes functionality for handling <a class="reference external" href="https://www.ngdc.noaa.gov/geomag/declination.shtml">declination</a>, but the value
of the declination must be specified by the user. There are two ways
to set a data-object’s declination:</p>
<ol class="arabic">
<li><p class="first">Set declination explicitly using the <code class="docutils literal notranslate"><span class="pre">dat.set_declination</span></code>
method, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dat</span><span class="o">.</span><span class="n">set_declination</span><span class="p">(</span><span class="mf">16.53</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">Set declination in the <code class="docutils literal notranslate"><span class="pre">&lt;data_filename&gt;.userdata.json</span></code> file
(<a class="reference external" href="json-userdata">more details</a> ), then read the binary data
file (i.e., using <code class="docutils literal notranslate"><span class="pre">dat</span> <span class="pre">=</span> <span class="pre">dolfyn.read(&lt;data_filename&gt;)</span></code>).</p>
</li>
</ol>
<p>Both of these approaches produce modify the <code class="docutils literal notranslate"><span class="pre">dat</span></code> as described in
the documentation for <a class="reference internal" href="api.html#dolfyn.Velocity.set_declination" title="dolfyn.Velocity.set_declination"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_declination()</span></code></a> .</p>
</div>
<div class="section" id="principal-heading">
<h2>Principal Heading<a class="headerlink" href="#principal-heading" title="Permalink to this headline">¶</a></h2>
<p>As described above, the principal coordinate system is meant to be the
flow-aligned coordinate system (Streamwise, Cross-stream, Up). DOLfYN
includes the <code class="xref py py-func docutils literal notranslate"><span class="pre">&lt;dolfyn.calc_principal_heading&gt;()</span></code> function to aide in
identifying/calculating the principal heading. Using this function to
identify the principal heading, an ADV data object that is in the
earth-frame can be rotated into the principal coordinate system like
this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dat</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;principal_heading&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dolfyn</span><span class="o">.</span><span class="n">calc_principal_heading</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">vel</span><span class="p">)</span>
<span class="n">dat</span><span class="o">.</span><span class="n">rotate2</span><span class="p">(</span><span class="s1">&#39;principal&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note here that if <code class="docutils literal notranslate"><span class="pre">dat</span></code> is in a coordinate system other than EARTH,
you will get unexpected results, because you will calculate a
<em>principal_heading</em> in the coordinate system that the data is in.</p>
<p>It should also be noted that by setting
<code class="docutils literal notranslate"><span class="pre">dat.props['principal_heading']</span></code> the user can choose any horizontal
coordinate system, and this might not be consistent with the
<em>streamwise, cross-stream, up</em> definition described here. In those
cases, the user should take care to clarify this point with
collaborators to avoid confusion.</p>
</div>
<div class="section" id="degree-of-testing-by-instrument-type">
<h2>Degree of testing by instrument type<a class="headerlink" href="#degree-of-testing-by-instrument-type" title="Permalink to this headline">¶</a></h2>
<p>The table below details the degree of testing of the rotation,
<em>p,r,h</em>, and coordinate-system tools contained in DOLfYN. The
<em>confidence</em> column provides a general indication of the level of
confidence that we have in these tools for each instrument.</p>
<p>If you encounter unexpected results that seem to be
related to coordinate systems (especially for instruments and
configurations that are listed as “low” or “medium” confidence), the
best thing to do is file <a class="reference external" href="http://github.com/lkilcher/dolfyn/issues/">an issue</a>.</p>
<span id="rotate-testing-table"></span><table border="1" class="colwidths-given docutils" id="id1">
<caption><span class="caption-text">Table 1: Instruments tested to be consistent with
DOLfYN’s coordinate systems and rotation tools.</span><a class="headerlink" href="#id1" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="12%" />
<col width="15%" />
<col width="23%" />
<col width="12%" />
<col width="38%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Make</th>
<th class="head">Model</th>
<th class="head">Config</th>
<th class="head">Confidence</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Nortek</td>
<td>Vector</td>
<td>modern (~2019) firmware</td>
<td>Medium</td>
<td>“Some direct “instrument on the desk” confirmation of orientation-matrix and p,r,h calcs.”</td>
</tr>
<tr class="row-odd"><td>Nortek</td>
<td>Vector</td>
<td>with IMU, modern (2019) firmware</td>
<td>High</td>
<td>“Lots of direct ‘instrument on the desk’ confirmation of orientation-matrix and p,r,h calcs.”</td>
</tr>
<tr class="row-even"><td>Nortek</td>
<td>Signature</td>
<td>modern (~2019) firmware</td>
<td>Medium</td>
<td>“Some validation by reasonable results when working with data.”</td>
</tr>
<tr class="row-odd"><td>Nortek</td>
<td>Signature</td>
<td>with IMU, modern (2019) firmware</td>
<td>Medium</td>
<td>“Some validation by reasonable results when working with data.”</td>
</tr>
<tr class="row-even"><td>Teledyne</td>
<td>Workhorse</td>
<td>modern (~2019-ish) firmware</td>
<td>Medium</td>
<td>“Some cross-validation with other sensors in post-processing, but minimal ‘instrument on the desk’ testing.”</td>
</tr>
<tr class="row-odd"><td>ALL</td>
<td>ALL</td>
<td>External input orientation data</td>
<td>NONE</td>
<td>“There has been no testing of external heading, pitch, or roll inputs”</td>
</tr>
<tr class="row-even"><td>Nortek</td>
<td>AWAC</td>
<td>modern (~2019) firmware</td>
<td>Low</td>
<td>“This works, but there has been almost no testing to validate results”</td>
</tr>
</tbody>
</table>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">DOLfYN</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Download and Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">The Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-structure.html">Data Structure</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Rotations and Coordinate Systems</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#orientation-data">Orientation Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#heading-pitch-roll">Heading, Pitch, Roll</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#dlfn-defined-heading-pitch-roll">DOLfYN-Defined Heading, Pitch, Roll</a></li>
<li class="toctree-l3"><a class="reference internal" href="#instrument-heading-pitch-roll">Instrument heading, pitch, roll</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#declination-handling">Declination Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#principal-heading">Principal Heading</a></li>
<li class="toctree-l2"><a class="reference internal" href="#degree-of-testing-by-instrument-type">Degree of testing by instrument type</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="motion-correction.html">Motion Correction</a></li>
<li class="toctree-l1"><a class="reference internal" href="plotting-tools.html">Plotting Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">The DOLfYN API</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="data-structure.html" title="previous chapter">Data Structure</a></li>
      <li>Next: <a href="motion-correction.html" title="next chapter">Motion Correction</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2014, Levi Kilcher.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/rotations.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>